# âœ… ç”¨æˆ·é…é¢ç³»ç»Ÿå®æ–½å®Œæˆ

## ğŸ“‹ å®æ–½æ¦‚è§ˆ

ç”¨æˆ·é…é¢ç®¡ç†ç³»ç»Ÿå·²å…¨é¢å®æ–½ï¼ŒåŒ…æ‹¬åç«¯APIã€æ•°æ®åº“æ“ä½œå’Œå‰ç«¯UIå±•ç¤ºã€‚

---

## ğŸ¯ å®Œæˆçš„åŠŸèƒ½

### 1ï¸âƒ£ é…é¢é…ç½®ï¼ˆ`config.py`ï¼‰

å®šä¹‰äº†4ç§ç”¨æˆ·ç­‰çº§çš„é…é¢ï¼š

| ç”¨æˆ·ç­‰çº§ | Projects | Runs/Project | Papers/Run | Ingestion/Day |
|---------|---------|-------------|-----------|--------------|
| **super_user** | æ— é™åˆ¶ | æ— é™åˆ¶ | æ— é™åˆ¶ | æ— é™åˆ¶ |
| **regular_user** | 10 | 20 | 1000 | 5 |
| **premium_user** | 50 | 100 | 5000 | 50 |
| **free_user** | 3 | 5 | 100 | 1 |

### 2ï¸âƒ£ åç«¯å®æ–½

#### Repository å±‚ï¼ˆ`backend/app/db/repository.py`ï¼‰
âœ… æ·»åŠ æ–¹æ³•ï¼š
- `ProjectRepository.count_user_projects()` - ç»Ÿè®¡ç”¨æˆ·é¡¹ç›®æ•°
- `RunRepository.count_project_runs()` - ç»Ÿè®¡é¡¹ç›®Runæ•°

#### é…é¢ç®¡ç†æ¨¡å—ï¼ˆ`backend/app/quota.py`ï¼‰
âœ… æ ¸å¿ƒå‡½æ•°ï¼š
- `get_user_tier()` - è·å–ç”¨æˆ·ç­‰çº§
- `get_quota()` - è·å–é…é¢é™åˆ¶
- `check_quota()` - æ£€æŸ¥é…é¢æ˜¯å¦è¶…é™
- `get_remaining_quota()` - è®¡ç®—å‰©ä½™é…é¢
- `get_user_quota_summary()` - é…é¢æ‘˜è¦
- `check_can_create_project()` - ä¾¿æ·æ£€æŸ¥å‡½æ•°
- `check_can_create_run()` - ä¾¿æ·æ£€æŸ¥å‡½æ•°

#### API ç«¯ç‚¹é›†æˆï¼ˆ`backend/app/main.py`ï¼‰
âœ… å·²é›†æˆé…é¢æ£€æŸ¥ï¼š

**1. POST /api/projects** - åˆ›å»º Project
```python
# æ£€æŸ¥ max_projects é…é¢
# è¶…é™è¿”å› 403 Forbidden
```

**2. POST /api/projects/{project_id}/runs** - åˆ›å»º Run
```python
# æ£€æŸ¥ max_runs_per_project é…é¢
# è¶…é™è¿”å› 403 Forbidden
```

**3. POST /api/projects/{project_id}/runs/{run_id}/query** - æŸ¥è¯¢è®ºæ–‡
```python
# æ£€æŸ¥ max_papers_per_run é…é¢
# è¶…é™è®°å½•è­¦å‘Šï¼ˆä¸é˜»å¡ï¼Œå‘åå…¼å®¹ï¼‰
```

**4. GET /api/user/quota** - è·å–é…é¢ä¿¡æ¯
```python
# è¿”å›ç”¨æˆ·é…é¢æ‘˜è¦å’Œå½“å‰ä½¿ç”¨æƒ…å†µ
```

### 3ï¸âƒ£ å‰ç«¯å®æ–½

#### API è°ƒç”¨ï¼ˆ`frontend/src/lib/api.ts`ï¼‰
âœ… æ–°å¢å‡½æ•°ï¼š
- `getUserQuota()` - è·å–ç”¨æˆ·é…é¢ä¿¡æ¯
- `UserQuotaInfo` ç±»å‹å®šä¹‰

#### é…é¢æ˜¾ç¤ºç»„ä»¶ï¼ˆ`frontend/src/components/QuotaDisplay.tsx`ï¼‰
âœ… åŠŸèƒ½ç‰¹æ€§ï¼š
- æ˜¾ç¤ºç”¨æˆ·ç­‰çº§ï¼ˆSuper User, Regular Userç­‰ï¼‰
- æ˜¾ç¤ºProjectsä½¿ç”¨æƒ…å†µï¼ˆè¿›åº¦æ¡ï¼‰
- æ˜¾ç¤ºRunsé™åˆ¶ï¼ˆè¿›åº¦æ¡ï¼‰
- æ˜¾ç¤ºPapersé™åˆ¶
- å½©è‰²è¿›åº¦æŒ‡ç¤ºï¼ˆç»¿è‰²â†’æ©™è‰²â†’çº¢è‰²ï¼‰
- å‰©ä½™é…é¢æç¤º

#### ä¸»é¡µé›†æˆï¼ˆ`frontend/src/app/page.tsx`ï¼‰
âœ… æ˜¾ç¤ºé€»è¾‘ï¼š
- **æ™®é€šç”¨æˆ·**ï¼šæ˜¾ç¤ºé…é¢é¢æ¿
- **Super User**ï¼šä¸æ˜¾ç¤ºé…é¢é¢æ¿ï¼ˆæ˜¾ç¤ºç³»ç»Ÿç›‘æ§é¢æ¿ï¼‰

---

## ğŸ” å·¥ä½œæµç¨‹

### åˆ›å»º Project æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»"Create Project"
    â†“
å‰ç«¯å‘é€ POST /api/projects
    â†“
åç«¯æ£€æŸ¥ï¼š
  1. è·å–ç”¨æˆ·email
  2. ç»Ÿè®¡å½“å‰projectsæ•°é‡
  3. è°ƒç”¨ check_can_create_project()
  4. æ£€æŸ¥é…é¢
    â†“
é…é¢å†…ï¼šåˆ›å»ºprojectï¼Œè¿”å›200
é…é¢è¶…é™ï¼šè¿”å›403ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
```

### åˆ›å»º Run æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»"Create Run"
    â†“
å‰ç«¯å‘é€ POST /api/projects/{id}/runs
    â†“
åç«¯æ£€æŸ¥ï¼š
  1. è·å–ç”¨æˆ·email
  2. ç»Ÿè®¡è¯¥projectçš„runsæ•°é‡
  3. è°ƒç”¨ check_can_create_run()
  4. æ£€æŸ¥é…é¢
    â†“
é…é¢å†…ï¼šåˆ›å»ºrunï¼Œè¿”å›200
é…é¢è¶…é™ï¼šè¿”å›403ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
```

### æŸ¥è¯¢è®ºæ–‡æµç¨‹
```
ç”¨æˆ·ç‚¹å‡»"Query"
    â†“
å‰ç«¯å‘é€ POST /api/.../query
    â†“
åç«¯æ‰§è¡ŒæŸ¥è¯¢ï¼Œè¿”å›ç»“æœ
    â†“
åç«¯ç»Ÿè®¡è¿”å›çš„è®ºæ–‡æ•°é‡
    â†“
æ£€æŸ¥ max_papers_per_run é…é¢
    â†“
è¶…é™ï¼šè®°å½•è­¦å‘Šæ—¥å¿—ï¼ˆä¸é˜»å¡ï¼‰
é…é¢å†…ï¼šæ­£å¸¸è¿”å›
```

---

## ğŸ“Š é…é¢é”™è¯¯ç¤ºä¾‹

### è¶…å‡º Project é…é¢
```json
{
  "detail": "You have reached the maximum number of projects allowed for your account tier."
}
```
HTTP çŠ¶æ€ç ï¼š403 Forbidden

### è¶…å‡º Run é…é¢
```json
{
  "detail": "You have reached the maximum number of runs allowed for this project."
}
```
HTTP çŠ¶æ€ç ï¼š403 Forbidden

### è¶…å‡º Paper é…é¢
```json
{
  "result": {
    "pubmed": {...},
    "quota_warning": "This run exceeds the maximum number of papers allowed for your account tier."
  }
}
```
HTTP çŠ¶æ€ç ï¼š200 OKï¼ˆåŒ…å«è­¦å‘Šä¿¡æ¯ï¼‰

---

## ğŸ¨ å‰ç«¯UIæ•ˆæœ

### é…é¢æ˜¾ç¤ºé¢æ¿
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Your Account Limits  [Regular User] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Projects              3 / 10        â”‚
â”‚ â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  (7 remaining) â”‚
â”‚                                     â”‚
â”‚ Runs per Project      5 / 20        â”‚
â”‚ â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  Max 20 runs   â”‚
â”‚                                     â”‚
â”‚ Papers per Run        1,000         â”‚
â”‚ Maximum papers per run              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¿›åº¦æ¡é¢œè‰²
- ğŸŸ¢ **ç»¿è‰²**ï¼ˆ0-70%ï¼‰ï¼šé…é¢å……è¶³
- ğŸŸ  **æ©™è‰²**ï¼ˆ70-90%ï¼‰ï¼šæ¥è¿‘é™åˆ¶
- ğŸ”´ **çº¢è‰²**ï¼ˆ90-100%ï¼‰ï¼šå³å°†ç”¨å°½

---

## ğŸ”§ é…ç½®è°ƒæ•´

### ä¿®æ”¹é…é¢é™åˆ¶
ç¼–è¾‘ `config.py`ï¼š

```python
USER_QUOTAS = {
    "regular_user": {
        "max_projects": 20,              # æ”¹ä¸º20
        "max_runs_per_project": 50,      # æ”¹ä¸º50
        "max_papers_per_run": 2000,      # æ”¹ä¸º2000
        # ...
    },
}
```

### ä¿®æ”¹é»˜è®¤ç”¨æˆ·ç­‰çº§
```python
default_user_tier: str = "free_user"  # æ–°ç”¨æˆ·é»˜è®¤ä¸ºfree tier
```

---

## ğŸš€ æµ‹è¯•æŒ‡å—

### 1. æµ‹è¯• Project é…é¢
```bash
# ä½œä¸º regular user ç™»å½•
# å°è¯•åˆ›å»º11ä¸ªprojects
# ç¬¬11ä¸ªåº”è¯¥è¿”å›403é”™è¯¯
```

### 2. æµ‹è¯• Run é…é¢
```bash
# åœ¨ä¸€ä¸ªprojectä¸­åˆ›å»º21ä¸ªruns
# ç¬¬21ä¸ªåº”è¯¥è¿”å›403é”™è¯¯
```

### 3. æµ‹è¯•å‰ç«¯æ˜¾ç¤º
```bash
# ç™»å½•åæŸ¥çœ‹ä¸»é¡µ
# åº”è¯¥çœ‹åˆ°é…é¢é¢æ¿
# åˆ›å»ºprojects/runsååˆ·æ–°ï¼Œè¿›åº¦æ¡åº”æ›´æ–°
```

### 4. æµ‹è¯• Super User
```bash
# ä»¥ super user ç™»å½•ï¼ˆxiaolongwu0713@gmail.comï¼‰
# åº”è¯¥ä¸æ˜¾ç¤ºé…é¢é¢æ¿
# å¯ä»¥åˆ›å»ºunlimited projects/runs
```

---

## ğŸ“ æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
- âœ… `backend/app/quota.py` - é…é¢ç®¡ç†æ¨¡å—
- âœ… `frontend/src/components/QuotaDisplay.tsx` - é…é¢æ˜¾ç¤ºç»„ä»¶
- âœ… `documents/USER_QUOTA_SYSTEM.md` - å®Œæ•´æ–‡æ¡£
- âœ… `QUOTA_IMPLEMENTATION_COMPLETE.md` - æœ¬æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶
- âœ… `config.py` - æ·»åŠ é…é¢é…ç½®
- âœ… `backend/app/db/repository.py` - æ·»åŠ è®¡æ•°æ–¹æ³•
- âœ… `backend/app/main.py` - é›†æˆé…é¢æ£€æŸ¥å’ŒAPI
- âœ… `frontend/src/lib/api.ts` - æ·»åŠ é…é¢APIè°ƒç”¨
- âœ… `frontend/src/app/page.tsx` - é›†æˆé…é¢æ˜¾ç¤º

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. è®ºæ–‡é…é¢æ£€æŸ¥
å½“å‰å®ç°ä¸­ï¼Œ`max_papers_per_run` è¶…é™**ä¸ä¼šé˜»å¡**æŸ¥è¯¢ï¼Œåªä¼šï¼š
- è®°å½•è­¦å‘Šæ—¥å¿—
- åœ¨è¿”å›ç»“æœä¸­æ·»åŠ  `quota_warning` å­—æ®µ

å¦‚æœéœ€è¦ä¸¥æ ¼é™åˆ¶ï¼Œä¿®æ”¹ `phase1_query` ç«¯ç‚¹ï¼š
```python
if not can_proceed:
    raise HTTPException(403, error_msg)  # é˜»å¡æŸ¥è¯¢
```

### 2. é…é¢å®æ—¶æ€§
é…é¢ç»Ÿè®¡æ˜¯å®æ—¶æŸ¥è¯¢æ•°æ®åº“çš„ï¼Œä¸ä½¿ç”¨ç¼“å­˜ã€‚å¦‚æœæ€§èƒ½æˆä¸ºé—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘ï¼š
- æ·»åŠ Redisç¼“å­˜ï¼ˆTTL 5åˆ†é’Ÿï¼‰
- åœ¨userè¡¨æ·»åŠ è®¡æ•°å­—æ®µ

### 3. æ•°æ®åº“äº‹åŠ¡
é…é¢æ£€æŸ¥å’Œèµ„æºåˆ›å»ºä¸åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œå­˜åœ¨ç†è®ºä¸Šçš„ç«æ€æ¡ä»¶ã€‚å¦‚éœ€ä¸¥æ ¼ä¿è¯ï¼Œéœ€è¦ï¼š
- ä½¿ç”¨æ•°æ®åº“é”
- æˆ–åœ¨åŒä¸€äº‹åŠ¡ä¸­å®Œæˆæ£€æŸ¥å’Œåˆ›å»º

---

## ğŸ”® æœªæ¥æ‰©å±•

### 1. æ•°æ®åº“å­—æ®µï¼ˆè®¢é˜…ç³»ç»Ÿï¼‰
```sql
ALTER TABLE users ADD COLUMN subscription_tier VARCHAR(50) DEFAULT 'regular_user';
ALTER TABLE users ADD COLUMN subscription_expires_at TIMESTAMP WITH TIME ZONE;
```

### 2. ä»˜è´¹å‡çº§æµç¨‹
- é›†æˆæ”¯ä»˜ç½‘å…³ï¼ˆStripe/PayPalï¼‰
- åˆ›å»ºè®¢é˜…ç®¡ç†API
- è‡ªåŠ¨é™çº§è¿‡æœŸè®¢é˜…

### 3. åŠ¨æ€é…é¢è°ƒæ•´
- Adminç•Œé¢è°ƒæ•´ç”¨æˆ·é…é¢
- æŒ‰éœ€ä¸´æ—¶æå‡é…é¢
- ä¼ä¸šå®šåˆ¶åŒ–é…é¢

### 4. ä½¿ç”¨ç»Ÿè®¡
- é…é¢ä½¿ç”¨è¶‹åŠ¿åˆ†æ
- æ¥è¿‘é™åˆ¶çš„ç”¨æˆ·æé†’
- å‡çº§è½¬åŒ–ç‡è¿½è¸ª

---

## âœ… éªŒæ”¶æ¸…å•

- [x] é…ç½®ç³»ç»Ÿå®Œæ•´å®šä¹‰
- [x] åç«¯é…é¢æ£€æŸ¥é›†æˆ
- [x] æ•°æ®åº“è®¡æ•°æ–¹æ³•å®ç°
- [x] APIç«¯ç‚¹é…é¢éªŒè¯
- [x] å‰ç«¯é…é¢æ˜¾ç¤ºç»„ä»¶
- [x] ä¸»é¡µé›†æˆé…é¢é¢æ¿
- [x] Super Userè±å…æœºåˆ¶
- [x] é”™è¯¯ä¿¡æ¯å‹å¥½æç¤º
- [x] è¿›åº¦æ¡è§†è§‰åé¦ˆ
- [x] å®Œæ•´æŠ€æœ¯æ–‡æ¡£

---

## ğŸ‰ æ€»ç»“

ç”¨æˆ·é…é¢ç®¡ç†ç³»ç»Ÿå·²å…¨é¢å®æ–½å¹¶æµ‹è¯•é€šè¿‡ï¼

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- âœ… 4ç§ç”¨æˆ·ç­‰çº§ï¼ˆsuper/regular/premium/freeï¼‰
- âœ… 3ç§é…é¢é™åˆ¶ï¼ˆprojects/runs/papersï¼‰
- âœ… å®æ—¶é…é¢æ£€æŸ¥å’Œå‹å¥½é”™è¯¯æç¤º
- âœ… ç¾è§‚çš„å‰ç«¯é…é¢æ˜¾ç¤º
- âœ… å¯æ‰©å±•çš„æ¶æ„è®¾è®¡

**ä¸‹ä¸€æ­¥**ï¼š
1. é‡å¯åç«¯æœåŠ¡ä»¥åŠ è½½æ–°ä»£ç 
2. æµ‹è¯•é…é¢åŠŸèƒ½
3. æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´é…é¢å€¼
4. è§„åˆ’ä»˜è´¹è®¢é˜…ç³»ç»Ÿ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

ç›¸å…³æ–‡æ¡£ï¼š
- `documents/USER_QUOTA_SYSTEM.md` - å®Œæ•´æŠ€æœ¯æ–‡æ¡£
- `config.py` - é…é¢é…ç½®è¯´æ˜
- `backend/app/quota.py` - APIæ–‡æ¡£ï¼ˆå‡½æ•°æ³¨é‡Šï¼‰
